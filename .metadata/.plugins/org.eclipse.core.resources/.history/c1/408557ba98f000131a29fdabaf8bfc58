#include "include/graph_struct.h"
#include "include/grid_mrf.h"

#include <opencv2/core/core.hpp>
#include <opencv2/imgproc/imgproc.hpp>
#include <opencv2/highgui/highgui.hpp>

#include <iostream>
using namespace std;
using namespace cv;

int main(int argc, char **argv)
{
	if (argc < 3)
	{
		cout << "Parameters too few." << endl;
		return 1;
	}

	Mat left_img = imread(string(argv[1]), CV_LOAD_IMAGE_GRAYSCALE);
	Mat right_img = imread(string(argv[2]), CV_LOAD_IMAGE_GRAYSCALE);

	if (left_img.rows != right_img.rows || left_img.cols != right_img.cols)
	{
		return 2;
	}

	int rows = left_img.rows;
	int cols = left_img.cols;
	int **observed_data = new int*[rows * cols];
	for (int i = 0; i < rows * cols; i++)
	{
		observed_data[i] = new int[LABEL_SET_SIZE];
	}

	for (int y = 0; y < rows; y++)
	{
		for (int x = 0; x < cols; x++)
		{
			int loc = y * cols + x;
			for (int k = 0; k < LABEL_SET_SIZE; k++)
			{
			    int x0 = x;
			    int x1 = max(x0 - k, 0);
			    observed_data[loc][k] = abs(left_img.at<unsigned char>(y, x0) - right_img.at<unsigned char>(y, x1));
			}
		}
	}


    grid_mrf mrf(4, 5);
    mrf.draw_graph();

    mrf.inference(0, true);
	return 0;
}
